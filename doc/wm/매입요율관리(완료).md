# 매입요율관리 (Purchase Rate Management) PRD

## 1. 개요
창고 매니저가 **매입요율**을 조회, 등록, 수정, 삭제하는 화면이다. Master-Detail 구조로 이루어져 있으며, 매입요율(Master)과 각 요율의 적용 기간 및 단가 정보(Detail)를 관리한다.

## 2. User Flow

1. **화면 진입 및 초기화 (`OPEN` 이벤트)**
   - WMS 시스템에서 "매입요율관리" 메뉴 진입.
   - 검색 조건의 "적용일자 From"은 당해년도 1월 1일, "To"는 오늘 날짜(Sysdate)로 기본 설정된다.
   - "사용여부" 검색 조건은 'Y'가 기본값으로 설정된다.

2. **조건별 검색 (`매입요율목록검색` 이벤트)**
   - 검색 조건(작업장, 계약협력사, 매입항목, 사용여부, 적용일자)을 입력하고 [검색] 버튼을 클릭.
   - DB(TB_WM06001, TB_WM06002 조인)에서 조건에 맞는 데이터를 조회하여 **Master 그리드(요율목록)**에 표시.

3. **상세 조회 (`매입요율상세목록검색` 이벤트)**
   - **요율목록** 그리드에서 하나의 행을 클릭.
   - 선택된 행의 요율키(창고정산요율번호)를 기반으로 **요율상세목록** 데이터를 조회하여 **Detail 그리드**에 표시.

4. **신규 행 추가 (`요율목록행추가` / `요율상세목록행추가` 이벤트)**
   - **Master(요율목록)**: [행추가] 버튼을 클릭해 새 행을 추가. 작업장과 계약협력사는 조회 조건의 값으로 기본 세팅됨. 매출입구분(sell_buy_sctn_cd)은 '20'(매입)으로 자동 설정됨.
   - **Detail(요율상세목록)**: Master 행이 포커스된 상태에서 Detail 그리드의 [행추가] 버튼 클릭하여 필수 정보 (확정여부, 시작일자, 종료일자, 단가, 통화코드) 입력.
   - *(규칙)* Master만 신규 추가하고 Detail이 없는 상태로는 저장 불가능. 최소 1개 이상의 Detail 행이 있어야 함.

5. **정보 수정 및 저장 (`저장` 이벤트)**
   - 조회된 데이터를 그리드 상에서 수정.
     - **Master 수정 가능 항목**: 매입아이템유형, 매입아이템, 매입단위분류, 매입단위, 사용여부, 비고
     - **Detail 수정 가능 항목**: 전체 항목
   - [저장] 버튼 클릭 시 일괄 트랜잭션 처리 (생성, 수정 처리).
   - *(규칙)* 상세목록에서 적용종료일자 >= 적용시작일자 검증 수행.

---

## 3. UI Component List (Rails 8 / Hotwire)

`STIMULUS_COMPONENTS_GUIDE.md`를 기반으로 한 공통 컴포넌트 목록:

- **Page Container**: `System::BasePageComponent` 상속 (`app/components/wm/pur_fee_rt_mng/page_component.rb`)
- **Search Form**: `Ui::SearchFormComponent` (Controller: `search-form`)
  - 필드명: 작업장(팝업), 계약협력사(팝업), 매입항목(팝업), 사용여부(Select), 적용일자(Date Range)
- **Grid 영역 (Master-Detail)**: 
  - Master Grid: `Ui::AgGridComponent` (+ `Ui::GridToolbarComponent`)
    - JavaScript Controller: `wm_pur_fee_rt_grid_controller` (또는 `ag-grid` 확장)
  - Detail Grid: `Ui::AgGridComponent` (+ `Ui::GridToolbarComponent`)
    - JavaScript Controller: `wm_pur_fee_rt_dtl_grid_controller`
- **Popup / Modals**:
  - `Ui::ModalShellComponent` 호출 플러그인 연동 (작업장 팝업, 거래처 팝업, 매입항목 팝업, 아이템 팝업)

---

## 4. Data Mapping

### 4.1 테이블 매핑

#### Master: `TB_WM06001` (보관정산요율)
| 화면 항목명 | 영문 컬럼명 | 필수 | 형식 / 공통코드 | 비고 |
| --- | --- | --- | --- | --- |
| 작업장 | `work_pl_cd` | M | String | |
| 매출입구분코드 | `sell_buy_sctn_cd` | M | `20` (매입) | Hidden / 하드코딩 저장 |
| 계약협력사 | `ctrt_cprtco_cd` | M | String | 팝업 조회 |
| 매입항목 | `sell_buy_attr_cd`| M | String | 팝업 조회 |
| 매입부서 | `pur_dept_cd` | M | String | 팝업 조회 |
| 매입아이템유형 | `pur_item_type` | M | **기타코드 `69`** | Select Box |
| 매입아이템 | `pur_item_cd` | M | String | 팝업 조회 |
| 매입단위분류 | `pur_unit_clas_cd`| M | **기타코드 `20`** | Select Box |
| 매입단위 | `pur_unit_cd` | M | 기타코드 `20` 하위 | 계층형 Select 방불 |
| 사용여부 | `use_yn` | M | **기타코드 `06`** | Y/N |
| 자동여부 | `auto_yn` | M | **기타코드 `06`** | Y/N |
| 비고 | `rmk` | | String | |

#### Detail: `TB_WM06002` (보관정산요율상세)
| 화면 항목명 | 영문 컬럼명 | 필수 | 형식 / 공통코드 | 비고 |
| --- | --- | --- | --- | --- |
| 확정여부 | `dcsn_yn` | M | **기타코드 `06`** | |
| 적용시작일자 | `aply_strt_ymd` | M | Date | <= 종료일자 |
| 적용종료일자 | `aply_end_ymd` | M | Date | >= 시작일자 |
| 적용단가 | `aply_uprice` | M | Number | |
| 통화코드 | `cur_cd` | M | **기타코드 `27`** | |
| 기준작업물량 | `std_work_qty` | M | Number | |
| 적용시작물량 | `aply_strt_qty` | | Number | |
| 적용종료물량 | `aply_end_qty` | | Number | |
| 비고 | `rmk` | | String | |

### 4.2 시스템 공통코드 (`AdmCodeDetail` 사용)
- 하드코딩하지 않고 데이터베이스의 `AdmCodeDetail`에서 가져오기:
  - `06`: 사용여부, 자동여부, 확정여부 (Y/N 류)
  - `20`: 매입단위분류 및 매입단위
  - `27`: 화폐코드 (KRW, USD 등)
  - `69`: 매출/매입 아이템유형

---

## 5. Logic Definition (비즈니스 로직)

### 5.1 조회 로직 (`GET /wm/pur_fee_rt_mngs`)
- **Master 목록 조회 Query 특징**:
  - `TB_WM06001` (A) 와 `TB_WM06002` (B) INNER JOIN.
  - 검색조건: `a.sell_buy_sctn_cd = '20'`, 법인코드, 작업장, 매입항목코드 등 일치.
  - 상세 날짜 교집합: 조회조건의 `From ~ To` 날짜가 `b.aply_strt_ymd` 및 `b.aply_end_ymd` 구간과 겹치는지 DB 조건 검증.
- **Detail 목록 조회 (`GET /wm/pur_fee_rt_mngs/:id`)**:
  - Master 클릭 시 Ajax 혹은 Fetch API 로 호출.
  - `wrhs_exca_fee_rt_no` 로 `TB_WM06002` 검색 후 배열 반환.

### 5.2 저장 로직 (`POST /wm/pur_fee_rt_mngs/collection_save`)
Grid에서 생성/수정/삭제된 데이터를 일괄 전송(JSON) 받아 단일 트랜잭션 내에서 처리 (`BaseCrudController`의 `save` 혹은 Grid의 save 액션 활용).

- **유효성 검증(Validation)**:
  - *마스터 신규 룰*: "매입요율상세"(Detail)를 1건 이상 등록해야 함. 없으면 `요율상세를 등록하시기 바랍니다` 예외 반환.
  - *일자 역전 룰*: 등록/수정 Detail의 `aply_end_ymd` < `aply_strt_ymd` 인 경우 실패 처리.
  - *필수값 체크*: 매입항목, 부서, 타입, 단위, 여부 등의 M 속성값 누락 확인.

- **Master 처리**:
  - Insert: `wrhs_exca_fee_rt_no`는 `SQ_TB_WM06001_FEE_RT_NO` (혹은 Rails `SecureRandom`/ID 전략에 맞춰) 발급. `sell_buy_sctn_cd`는 `20` 고정 삽입.
  - Update: `pur_item_type`, `pur_item_cd`, `pur_unit_clas_cd`, `pur_unit_cd`, `use_yn`, `rmk` 값만 안전하게 업데이트 (Strong Parameters 필터링).

- **Detail 처리**:
  - Master의 키 값을 외래키로 매핑.
  - Insert 시: `wrhs_exca_fee_rt_seq` 컬럼을 1씩 순차 증가(또는 Max+1) 방식으로 발급하여 저장.
  - 삭제, 추가, 수정을 요청 데이터의 `_destroy`, `id` 유무로 식별하여 영속성 처리 (ActiveRecord Nested Attributes 또는 수동 서비스 로직).
