# 로그인 기능 구현 완료 보고

## 개요

PRD(`PRD_로그인.md`)에 정의된 설계를 기반으로, WMS Pro 앱에 비밀번호 기반 로그인 기능을 구현했습니다. 다크 테마 중앙 카드 레이아웃의 로그인 화면과 세션 기반 인증 시스템이 포함됩니다.

---

## 구현 범위

| 기능 | 상태 |
|------|------|
| 미인증 사용자 → 로그인 페이지 리다이렉트 | 완료 |
| 이메일 + 비밀번호 인증 | 완료 |
| 로그인 후 원래 페이지로 복귀 | 완료 |
| 로그인 실패 시 에러 메시지 표시 | 완료 |
| 다크 테마 중앙 카드 로그인 화면 | 완료 |
| 사이드바 동적 사용자 이메일 표시 | 완료 |
| 사이드바 로그아웃 버튼 | 완료 |
| 시드 데이터 (기본 관리자 계정) | 완료 |
| 유닛/통합 테스트 | 완료 |

---

## 파일 변경 목록

### 신규 생성

| 파일 | 설명 |
|------|------|
| `app/models/user.rb` | 사용자 모델 (`has_secure_password`, 이메일 검증/정규화) |
| `app/models/session.rb` | 세션 모델 (토큰 자동 생성) |
| `app/models/current.rb` | `ActiveSupport::CurrentAttributes` 기반 요청 컨텍스트 |
| `app/controllers/concerns/authentication.rb` | 인증 Concern (쿠키 기반 세션 관리) |
| `app/controllers/sessions_controller.rb` | 로그인/로그아웃 컨트롤러 (`session` 레이아웃 사용) |
| `app/views/layouts/session.html.erb` | 로그인 전용 최소 레이아웃 (사이드바/탭 없음) |
| `app/views/sessions/new.html.erb` | 로그인 폼 뷰 |
| `db/migrate/20260212142605_create_users.rb` | users 테이블 (`null: false`, unique email index) |
| `db/migrate/20260212142618_create_sessions.rb` | sessions 테이블 (`null: false` token, unique index) |
| `test/controllers/sessions_controller_test.rb` | 컨트롤러 테스트 (7개) |
| `test/integration/authentication_test.rb` | 인증 통합 테스트 (4개) |

### 수정

| 파일 | 변경 내용 |
|------|----------|
| `Gemfile` | `bcrypt` 젬 주석 해제 |
| `config/routes.rb` | `resource :session, only: [:new, :create, :destroy]` 추가 |
| `app/controllers/application_controller.rb` | `include Authentication` 추가 |
| `app/assets/stylesheets/application.css` | 로그인 페이지 CSS 추가 (`.login-container`, `.login-card` 등) |
| `app/views/shared/_sidebar.html.erb` | 동적 사용자 이메일 표시 + 로그아웃 버튼 추가 |
| `db/seeds.rb` | 기본 관리자 사용자 생성 코드 추가 |
| `test/fixtures/users.yml` | 테스트용 사용자 픽스처 |
| `test/fixtures/sessions.yml` | 테스트용 세션 픽스처 |
| `test/models/user_test.rb` | User 모델 테스트 (6개) |
| `test/models/session_test.rb` | Session 모델 테스트 (3개) |

---

## 기술 상세

### 데이터 모델

#### User

```ruby
class User < ApplicationRecord
  has_secure_password
  has_many :sessions, dependent: :destroy

  validates :email_address, presence: true,
                            uniqueness: true,
                            format: { with: URI::MailTo::EMAIL_REGEXP }

  normalizes :email_address, with: ->(e) { e.strip.downcase }
end
```

- `bcrypt` 기반 비밀번호 해싱 (`has_secure_password`)
- 이메일 자동 정규화 (공백 제거 + 소문자 변환)
- `authenticate_by` 메서드로 인증 처리

#### Session

```ruby
class Session < ApplicationRecord
  belongs_to :user
  before_create :generate_token  # SecureRandom.urlsafe_base64(32)
end
```

- 생성 시 `SecureRandom.urlsafe_base64(32)`로 토큰 자동 생성
- `user_agent`, `ip_address` 기록

#### Current

```ruby
class Current < ActiveSupport::CurrentAttributes
  attribute :session, :user
end
```

- 요청 스코프 내에서 `Current.user`, `Current.session` 접근 가능

### 인증 흐름

```
브라우저 요청
    │
    ▼
Authentication Concern (before_action :require_authentication)
    │
    ├── 서명 쿠키(session_token) 존재? ──Yes──▶ Session 조회 → Current 설정 → 요청 처리
    │
    └── No ──▶ 로그인 페이지로 리다이렉트 (원래 URL 저장)
```

- **쿠키**: `cookies.signed.permanent[:session_token]` (httponly, same_site: lax)
- **로그인 후 복귀**: `session[:return_to_after_authenticating]`에 원래 URL 저장

### 라우팅

| HTTP 메서드 | 경로 | 컨트롤러#액션 | 용도 |
|------------|------|-------------|------|
| GET | `/session/new` | `sessions#new` | 로그인 폼 |
| POST | `/session` | `sessions#create` | 로그인 처리 |
| DELETE | `/session` | `sessions#destroy` | 로그아웃 |

### UI

- **로그인 페이지**: `layouts/session.html.erb` 레이아웃 사용 (사이드바/탭/헤더 없음)
- **카드 레이아웃**: 중앙 정렬, `max-width: 420px`, `radial-gradient` 배경
- **기존 CSS 변수 재사용**: `--bg-primary`, `--bg-secondary`, `--accent`, `--border` 등
- **사이드바 하단**: 로그인 사용자 이메일 동적 표시 + 로그아웃 버튼

---

## 테스트 결과

```
20 tests, 46 assertions, 0 failures, 0 errors, 0 skips
```

### User 모델 테스트 (6개)

- 유효한 속성으로 생성 가능
- `email_address` 필수
- `password` 필수
- 중복 `email_address` 거부
- `email_address` 소문자 정규화
- 잘못된 이메일 형식 거부

### Session 모델 테스트 (3개)

- User 연결 확인
- 생성 시 토큰 자동 생성
- 각 세션마다 고유 토큰

### SessionsController 테스트 (7개)

- `GET /session/new` — 로그인 페이지 렌더링
- 이미 인증된 상태에서도 로그인 페이지 접근 가능
- 올바른 자격증명 → 리다이렉트 + 쿠키 설정
- 잘못된 비밀번호 → 422
- 존재하지 않는 이메일 → 422
- 로그인 후 원래 URL로 리다이렉트
- 로그아웃 → 세션 삭제 + 로그인 페이지 이동

### 인증 통합 테스트 (4개)

- 미인증 사용자 → 로그인 리다이렉트
- 인증 사용자 → 보호 페이지 접근 가능
- 로그인 → 원래 페이지 복귀
- 로그아웃 → 보호 페이지 접근 불가

### RuboCop

신규/수정 파일 전체 — **0 offenses**

---

## 기본 계정

| 항목 | 값 |
|------|-----|
| 이메일 | `admin@example.com` |
| 비밀번호 | `password` |

`bin/rails db:seed`로 생성됩니다.

---

## 검증 방법

```bash
# 1. 의존성 설치
bundle install

# 2. DB 마이그레이션 + 시드
bundle exec rails db:migrate
bundle exec rails db:seed

# 3. 서버 실행
bin/rails server

# 4. 동작 확인
# - http://localhost:3000/ → 로그인 페이지로 리다이렉트
# - 잘못된 비밀번호 → 에러 메시지 표시
# - admin@example.com / password → 대시보드 이동
# - 사이드바 하단 사용자 이메일 표시
# - 로그아웃 → 로그인 페이지 이동

# 5. 테스트
bundle exec rails db:test:prepare test

# 6. 린트
bundle exec rubocop
```
