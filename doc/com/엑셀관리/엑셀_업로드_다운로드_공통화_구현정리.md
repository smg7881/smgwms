# 엑셀 업로드/다운로드 공통화 구현 정리

## 1. 문서 목적
이 문서는 `smgWms` 프로젝트에서 구현한 엑셀 기능(다운로드/업로드)의 공통화 작업을 상세히 정리한 문서입니다.

정리 대상은 다음과 같습니다.
- 사용자(`system/users`) / 부서(`system/dept`)의 엑셀 다운로드
- 사용자 / 부서의 엑셀 업로드
- 업로드 검증 정책(확장자, 파일 크기, 헤더)
- 실패 행 에러 리포트 저장
- 대용량 업로드(10,000건 초과) 비동기 처리
- 업로드 이력 관리자 화면 및 실패 리포트 다운로드

---

## 2. 구현 목표와 요구사항
요구사항은 아래 4가지였고, 모두 반영했습니다.

1. 파일 확장자/크기 검증
2. 헤더명 검증
3. 실패 행 에러 리포트 저장
4. 1만 건 이상 업로드 시 백그라운드 잡 처리

추가로 구현된 항목:
- 업로드 이력 조회 화면(`/system/excel_import_tasks`)
- 실패 리포트 다운로드 기능
- users/dept 화면에서 "업로드이력" 바로가기 버튼

---

## 3. 전체 아키텍처

### 3.1 공통화 전략
리소스별(users/dept)로 중복 구현하지 않고, 다음 구조로 공통화했습니다.

- Controller Concern: `System::ExcelTransferable`
  - `excel_template`
  - `excel_export`
  - `excel_import`
- Handler Registry + Resource Handler
  - `Excel::HandlerRegistry`
  - `Excel::Handlers::UsersHandler`
  - `Excel::Handlers::DeptHandler`
- 공통 서비스
  - 업로드 검증: `Excel::UploadValidator`
  - 헤더/행수 검사: `Excel::SpreadsheetInspector`
  - XLSX 생성: `Excel::WorkbookBuilder`
  - 실제 import 처리/에러리포트 생성: `Excel::ImportProcessor`
- 비동기 잡
  - `ExcelImportJob`
- 업로드 이력 저장 모델
  - `ExcelImportTask` (상태, 건수, 요청자, 에러 요약, 파일 첨부)

### 3.2 처리 흐름(업로드)
1. 화면에서 파일 선택 후 업로드 요청
2. `UploadValidator`로 확장자/크기 검증
3. `SpreadsheetInspector`로 헤더 및 데이터 행 수 확인
4. 헤더 불일치 시 즉시 실패 처리
5. 데이터 건수 기준 분기
   - `<= 10,000`: 동기 처리(`ImportProcessor`)
   - `> 10,000`: `ExcelImportJob.perform_later`
6. 실패 행이 있으면 CSV 리포트 생성 후 task에 첨부 저장
7. 이력 화면에서 상태/건수/리포트 확인

### 3.3 처리 흐름(다운로드)
1. 템플릿 다운로드: 헤더만 가진 XLSX 생성
2. 데이터 다운로드: 리소스별 scope -> row 변환 -> XLSX 생성

---

## 4. 주요 파일 변경 내역

## 4.1 Gem
- `Gemfile`
- `Gemfile.lock`

추가 gem:
- `caxlsx`
- `caxlsx_rails`
- `roo`

역할:
- `caxlsx`: xlsx 파일 생성
- `roo`: xlsx/csv 읽기

## 4.2 DB / 모델
- 마이그레이션: `db/migrate/20260218093000_create_excel_import_tasks.rb`
- 모델: `app/models/excel_import_task.rb`
- 스키마 반영: `db/schema.rb`

`excel_import_tasks` 주요 컬럼:
- `resource_key` (`users`, `dept`)
- `status` (`queued`, `processing`, `completed`, `completed_with_errors`, `failed`)
- `total_rows`, `success_rows`, `failed_rows`
- `source_filename`, `source_byte_size`
- `error_summary`
- `requested_by_id` (adm_users FK)
- `started_at`, `completed_at`
- 첨부파일
  - `source_file`
  - `error_report`

## 4.3 공통 서비스/핸들러
생성된 파일:
- `app/services/excel/handler_registry.rb`
- `app/services/excel/workbook_builder.rb`
- `app/services/excel/upload_validator.rb`
- `app/services/excel/spreadsheet_inspector.rb`
- `app/services/excel/import_processor.rb`
- `app/services/excel/handlers/base_handler.rb`
- `app/services/excel/handlers/users_handler.rb`
- `app/services/excel/handlers/dept_handler.rb`

핵심 포인트:
- 헤더 기준을 handler가 소유하여 템플릿/검증/파싱 기준을 일원화
- 헤더 첫 컬럼 BOM 제거 처리(`\uFEFF`)로 CSV 인코딩 이슈 방어
- 실패 행 리포트를 CSV로 생성하여 `error_report`에 첨부

## 4.4 컨트롤러/Concern/Job
- 공통 Concern: `app/controllers/concerns/system/excel_transferable.rb`
- 잡: `app/jobs/excel_import_job.rb`
- users 연동: `app/controllers/system/users_controller.rb`
- dept 연동: `app/controllers/system/dept_controller.rb`

`ExcelTransferable`에서 재정의 필요한 메서드:
- `excel_resource_key`
- `excel_export_scope`

리소스별 컨트롤러는 위 2개만 제공하면 동일 로직 사용 가능.

## 4.5 라우팅
- `config/routes.rb`

추가 라우트:
- users
  - `GET /system/users/excel_template`
  - `GET /system/users/excel_export`
  - `POST /system/users/excel_import`
- dept
  - `GET /system/dept/excel_template`
  - `GET /system/dept/excel_export`
  - `POST /system/dept/excel_import`
- import task
  - `GET /system/excel_import_tasks`
  - `GET /system/excel_import_tasks/:id/error_report`

## 4.6 이력 화면
- 컨트롤러: `app/controllers/system/excel_import_tasks_controller.rb`
- 뷰: `app/views/system/excel_import_tasks/index.html.erb`

기능:
- 최근 200건 조회
- 리소스/상태 필터
- 요청자, 건수, 상태 표시
- 오류 리포트 첨부 시 다운로드 링크 제공

## 4.7 프론트(UI/Stimulus/Component)
- 공통 JS: `app/javascript/controllers/base_crud_controller.js`
  - `downloadExcel`
  - `downloadExcelTemplate`
  - `openExcelImport`
  - `submitExcelImport`
  - `openImportHistory`
- users JS value 추가: `app/javascript/controllers/user_crud_controller.js`
- dept JS value 추가: `app/javascript/controllers/dept_crud_controller.js`

users 화면:
- `app/components/system/users/page_component.rb`
- `app/components/system/users/page_component.html.erb`

dept 화면:
- `app/components/system/dept/page_component.rb`
- `app/components/system/dept/page_component.html.erb`

추가 버튼:
- 엑셀양식
- 엑셀다운로드
- 엑셀업로드
- 업로드이력

숨김 업로드 폼을 두고 버튼 클릭 시 파일 선택창 오픈 -> submit 방식으로 구현.

## 4.8 탭 메뉴
- `app/models/tab_registry.rb`

추가 엔트리:
- `system-excel-import-tasks` (`/system/excel_import_tasks`)

---

## 5. 요구사항 1~4 반영 상세

## 5.1 확장자/크기 검증
구현 위치:
- `app/services/excel/upload_validator.rb`

정책:
- 허용 확장자: `csv`, `xlsx`
- 최대 크기: `10MB`

실패 시:
- 업로드 중단
- referer 또는 index로 redirect
- `flash[:alert]`로 오류 표시

## 5.2 헤더 검증
구현 위치:
- 1차 검사: `SpreadsheetInspector`
- 실제 import 직전 재검증: `ImportProcessor`

기준:
- 핸들러가 제공하는 `headers`와 업로드 헤더가 완전 일치해야 통과
- 순서까지 동일해야 함

추가 방어:
- 첫 헤더의 UTF-8 BOM 제거 처리

## 5.3 실패 행 에러 리포트 저장
구현 위치:
- `ImportProcessor`

동작:
- 행 단위 예외 처리
- 실패 시 `row_number`, `error_message`, `row_data(JSON)`를 수집
- 실패가 1건 이상이면 CSV 생성
- `ExcelImportTask#error_report`에 첨부 저장

효과:
- 전체 import는 진행하면서 실패 행만 후처리 가능
- 운영자가 실패 데이터 재정제 후 재업로드 가능

## 5.4 10,000건 초과 비동기 처리
구현 위치:
- 분기: `ExcelTransferable#excel_import`
- 잡: `ExcelImportJob`

정책:
- 데이터 행 수(`header 제외`)가 10,000 초과 시 `perform_later`

task 상태 전환:
- 접수 시: `queued`
- 잡 시작: `processing`
- 성공: `completed` 또는 `completed_with_errors`
- 실패: `failed`

---

## 6. 리소스별 헤더 정의

## 6.1 users
핸들러: `UsersHandler`

헤더:
- `user_id_code`
- `user_nm`
- `email_address`
- `dept_cd`
- `dept_nm`
- `role_cd`
- `position_cd`
- `job_title_cd`
- `work_status`
- `hire_date`
- `resign_date`
- `phone`
- `address`
- `detail_address`

업로드 규칙 주요점:
- `user_id_code` 필수
- 신규 유저는 비밀번호 자동 생성(`SecureRandom.hex(8)`)

## 6.2 dept
핸들러: `DeptHandler`

헤더:
- `dept_code`
- `dept_nm`
- `dept_type`
- `parent_dept_code`
- `dept_order`
- `use_yn`
- `description`

업로드 규칙 주요점:
- `dept_code` 필수
- `dept_order`는 정수 변환
- `use_yn` 공백 시 기본값 `Y`

---

## 7. 업로드 이력 화면 운영 가이드

화면 URL:
- `/system/excel_import_tasks`

조회 필터:
- 리소스(`users`, `dept`)
- 상태(`queued`, `processing`, `completed`, `completed_with_errors`, `failed`)

주요 확인 지표:
- `total_rows`
- `success_rows`
- `failed_rows`
- `error_summary`
- `error_report` 다운로드 여부

운영 절차 예시:
1. `completed_with_errors` 또는 `failed` 필터 조회
2. 리포트 다운로드
3. `row_data` 기반으로 데이터 정제
4. 템플릿 기준으로 재업로드

---

## 8. 테스트 정리

## 8.1 users 컨트롤러 테스트 보강
파일:
- `test/controllers/system/users_controller_test.rb`

추가 검증 케이스:
- 지원하지 않는 확장자 거부
- 10MB 초과 거부
- 헤더 불일치 거부 + task `failed`
- 실패 행 발생 시 `error_report` 첨부 저장
- 10,001행 업로드 시 `ExcelImportJob` enqueue

픽스처 파일:
- `test/fixtures/files/users_import_valid.csv`
- `test/fixtures/files/users_import_invalid_header.csv`
- `test/fixtures/files/users_import_with_error.csv`

## 8.2 이력 화면 테스트
파일:
- `test/controllers/system/excel_import_tasks_controller_test.rb`

케이스:
- admin 접근 성공
- non-admin 접근 금지(403)
- 오류 리포트 다운로드 성공

## 8.3 실행 결과
실행 명령:
- `ruby bin/rails test test/controllers/system/users_controller_test.rb test/controllers/system/dept_controller_test.rb test/controllers/system/excel_import_tasks_controller_test.rb`

결과:
- `16 runs, 46 assertions, 0 failures, 0 errors`

---

## 9. 사용자 동작 시나리오

## 9.1 템플릿 다운로드
1. 사용자/부서 화면 이동
2. `엑셀양식` 클릭
3. 템플릿 XLSX 다운로드

## 9.2 데이터 다운로드
1. 사용자/부서 화면 이동
2. 필요 시 검색조건 입력
3. `엑셀다운로드` 클릭
4. 현재 검색조건 기준 데이터 XLSX 다운로드

## 9.3 데이터 업로드
1. `엑셀업로드` 클릭
2. 파일 선택
3. 유효성/헤더 통과 시 처리 진행
4. 처리 결과 flash 확인

## 9.4 이력/리포트 확인
1. `업로드이력` 클릭
2. 상태/리소스 필터 조회
3. 실패 건의 `다운로드` 클릭

---

## 10. 트러블슈팅 메모

### 10.1 CSV BOM으로 인한 헤더 불일치
현상:
- 첫 컬럼 헤더가 맞는데 불일치로 실패

원인:
- UTF-8 BOM (`\uFEFF`) 포함

조치:
- `SpreadsheetInspector`, `ImportProcessor`에서 첫 헤더 BOM 제거

### 10.2 테스트 환경 마이그레이션 누락
현상:
- `Migrations are pending`

조치:
- `ruby bin/rails db:test:prepare`

---

## 11. 향후 개선 제안

1. 업로드 진행률 표시
- 현재는 queued/processing/completed 상태만 보이므로, 대용량 작업에 진행률 퍼센트 저장 컬럼 추가 고려

2. 리포트 상세화
- 현재 `row_data` JSON 문자열 저장
- 컬럼별 오류코드(예: `invalid_email`, `missing_required`)를 분리 저장하면 운영 효율 증가

3. 리소스 확장 자동화
- 신규 리소스 추가 시 handler만 생성하면 되지만, 헤더 템플릿 버전 관리 규칙(예: v1, v2) 도입하면 안정적

4. 권한 세분화
- 현재 admin만 접근
- 향후 `엑셀 업로드 권한`, `리포트 조회 권한` 등 분리 가능

---

## 12. 최종 요약
이번 작업으로 users/dept의 엑셀 다운로드/업로드 기능을 공통 아키텍처로 통합했으며, 운영 안정성 요구사항(검증/헤더/리포트/비동기)을 모두 만족했습니다. 또한 업로드 이력 관리 화면과 실패 리포트 다운로드 기능을 추가하여 운영자가 오류 데이터를 추적하고 재처리할 수 있는 체계를 갖췄습니다.

---

## 13. 화면 캡처 체크리스트
아래 표는 QA/산출물용 캡처를 빠르게 수집하기 위한 체크리스트입니다.

| No | 화면/기능 | 사전 조건 | 수행 절차 | 기대 결과 | 캡처 포인트 | 완료 |
|---|---|---|---|---|---|---|
| 1 | 사용자 화면 툴바 | 관리자 로그인 | `/system/users` 진입 | `엑셀양식`, `엑셀다운로드`, `엑셀업로드`, `업로드이력` 버튼 노출 | 툴바 전체 | [ ] |
| 2 | 부서 화면 툴바 | 관리자 로그인 | `/system/dept` 진입 | 4개 엑셀 버튼 노출 | 툴바 전체 | [ ] |
| 3 | 사용자 템플릿 다운로드 | `/system/users` 진입 | `엑셀양식` 클릭 | `users-template-YYYY-MM-DD.xlsx` 다운로드 | 브라우저 다운로드 바/파일명 | [ ] |
| 4 | 부서 템플릿 다운로드 | `/system/dept` 진입 | `엑셀양식` 클릭 | `dept-template-YYYY-MM-DD.xlsx` 다운로드 | 다운로드 파일명 | [ ] |
| 5 | 사용자 데이터 다운로드 | 사용자 목록 데이터 존재 | 검색조건 입력 후 `엑셀다운로드` 클릭 | 필터 반영된 xlsx 다운로드 | 검색조건 + 다운로드 결과 | [ ] |
| 6 | 부서 데이터 다운로드 | 부서 데이터 존재 | 검색조건 입력 후 `엑셀다운로드` 클릭 | 필터 반영된 xlsx 다운로드 | 검색조건 + 다운로드 결과 | [ ] |
| 7 | 업로드 확장자 검증 실패 | `.txt` 파일 준비 | `엑셀업로드`로 `.txt` 선택 | 업로드 실패 alert/flash 표시 | 오류 메시지 영역 | [ ] |
| 8 | 업로드 용량 검증 실패 | 10MB 초과 파일 준비 | `엑셀업로드` 수행 | 업로드 실패(10MB 제한) | 오류 메시지 영역 | [ ] |
| 9 | 헤더 불일치 실패 | 잘못된 헤더 CSV 준비 | `엑셀업로드` 수행 | 헤더 불일치 실패 | 오류 메시지 + 이력 상태(`failed`) | [ ] |
| 10 | 부분 성공 업로드 | 일부 행 오류 CSV 준비 | 업로드 수행 | `completed_with_errors`, 성공/실패 건수 반영 | flash 결과 + 이력 행 | [ ] |
| 11 | 실패 리포트 다운로드 | 오류 리포트 첨부 task 존재 | 이력 화면에서 `다운로드` 클릭 | CSV 정상 다운로드 | 다운로드 파일 + 해당 행 | [ ] |
| 12 | 대용량 비동기 접수 | 10,001행 이상 파일 준비 | 업로드 수행 | `queued` 후 `processing/completed` 전이 | 이력 상태 변화 | [ ] |
| 13 | 업로드이력 진입(users) | `/system/users` 진입 | `업로드이력` 클릭 | `/system/excel_import_tasks?q[resource_key]=users` 이동 | URL + 필터값 | [ ] |
| 14 | 업로드이력 진입(dept) | `/system/dept` 진입 | `업로드이력` 클릭 | `/system/excel_import_tasks?q[resource_key]=dept` 이동 | URL + 필터값 | [ ] |
| 15 | 이력 필터 조회 | 이력 데이터 존재 | 리소스/상태 선택 후 `조회` | 조건에 맞는 행만 표시 | 필터 입력값 + 결과 테이블 | [ ] |
| 16 | 권한 검증(비관리자) | 일반 사용자 로그인 | 이력 URL 직접 접근 | 접근 거부(403 또는 권한 없음 처리) | 응답 화면/코드 | [ ] |

### 13.1 캡처 파일명 권장 규칙
- `excel-users-toolbar.png`
- `excel-users-template-download.png`
- `excel-users-import-invalid-extension.png`
- `excel-users-import-header-mismatch.png`
- `excel-import-history-list.png`
- `excel-import-history-error-report-download.png`
- `excel-import-large-queued.png`

### 13.2 캡처 묶음 제출 권장 순서
1. 툴바 노출 (users/dept)
2. 템플릿/다운로드 성공
3. 업로드 실패 케이스(확장자/용량/헤더)
4. 업로드 부분성공 + 오류리포트 다운로드
5. 대용량 비동기 큐잉
6. 이력 필터 및 권한 검증

---

## 14. QA 결과 입력 양식
아래 표는 실제 테스트 수행 후 결과를 기록하기 위한 템플릿입니다.

| No | 테스트 항목 | 담당자 | 수행일 | 결과(PASS/FAIL) | 이슈번호 | 비고 |
|---|---|---|---|---|---|---|
| 1 | 사용자 화면 엑셀 버튼 노출 |  |  |  |  |  |
| 2 | 부서 화면 엑셀 버튼 노출 |  |  |  |  |  |
| 3 | 사용자 템플릿 다운로드 |  |  |  |  |  |
| 4 | 부서 템플릿 다운로드 |  |  |  |  |  |
| 5 | 사용자 데이터 다운로드(검색조건 반영) |  |  |  |  |  |
| 6 | 부서 데이터 다운로드(검색조건 반영) |  |  |  |  |  |
| 7 | 업로드 확장자 검증 실패(.txt) |  |  |  |  |  |
| 8 | 업로드 용량 검증 실패(10MB 초과) |  |  |  |  |  |
| 9 | 업로드 헤더 불일치 검증 실패 |  |  |  |  |  |
| 10 | 업로드 부분 성공 + 실패건 집계 |  |  |  |  |  |
| 11 | 실패 리포트 CSV 다운로드 |  |  |  |  |  |
| 12 | 대용량 업로드 비동기 큐잉(10,001+) |  |  |  |  |  |
| 13 | 업로드이력 버튼 이동(users) |  |  |  |  |  |
| 14 | 업로드이력 버튼 이동(dept) |  |  |  |  |  |
| 15 | 이력 화면 필터 조회(리소스/상태) |  |  |  |  |  |
| 16 | 비관리자 접근 권한 검증 |  |  |  |  |  |

### 14.1 테스트 실행 메타 정보
- 테스트 버전/브랜치:
- 테스트 환경(local/dev/stage/prod):
- 브라우저:
- DB 상태(샘플데이터/운영복제 등):
- 테스트 시작 시각:
- 테스트 종료 시각:
- 총 PASS:
- 총 FAIL:

### 14.2 FAIL 기록 템플릿
아래 블록을 FAIL 건마다 복사해서 사용합니다.

```text
[FAIL #]
- 테스트 항목:
- 재현 절차:
- 실제 결과:
- 기대 결과:
- 영향 범위:
- 첨부 캡처 파일명:
- 이슈번호:
- 조치 담당자:
- 조치 상태(Open/In Progress/Resolved):
```

## 15. 부록 문서
- QA 실행 시트: `doc/엑셀관리/엑셀_QA_실행시트.md`
