# 🚀 환율 정보 연동 배치 (개발 완료 및 사용 가이드)

본 문서는 WMS 시스템에서 `std_exchange_rates` (환율관리 테이블) 모델을 사용하여 외부 API(한국수출입은행)로부터 환율을 수집하고 저장하는 배치(Batch) 프로그램의 개발 내용과 사용법을 안내합니다.

---

## 1. 개발 내역 요약

*   **요구사항 반영**: 변경된 PRD에 따라, 기존에 등록된 `StdExchangeRate` 모델(`std_exchange_rates` 테이블)의 스키마 명세를 정확히 활용하여 매핑 및 Upsert 구문을 작성하였습니다.
*   **신규 작성 서비스**: `app/services/std/exchange_rate_sync_service.rb` 
    *   API 통신, JSON 데이터 파싱 (숫자 내 `,` 기호 대응), Upsert (`find_or_initialize_by`) 등을 수행하는 비즈니스 핵심 클래스입니다.
    *   **공휴일 스캔 기능 구현(Fallback)**: 오늘이 주말/공휴일 등 영업일이 아닐 경우(데이터 미존재) 가장 최근의 영업일 데이터를 이전 날짜로 거슬러 올라가 탐색 후 오늘 날짜로 생성합니다.
*   **신규 작성 잡(Job)**: `app/jobs/std/sync_exchange_rates_job.rb`
    *   위 서비스를 스케줄러(CronJob이나 Sidekiq)에서 비동기로 원활하게 트리거하기 위해 작성되었습니다.

---

## 2. 데이터 매핑 (API -> DB)

수출입은행 API에서 가져온 정보는 환율 테이블에 다음과 같이 등록/수정(Upsert)됩니다.
*(조회 기준은 대한민국의 기준 통화 정책이므로 국가코드(KR)와 금융기관명은 수동 고정 설정하였습니다.)*

| StdExchangeRate 컬럼명 | 입력값 / API 속성명 | 설명 |
| :--- | :--- | :--- |
| `ctry_cd` (국가코드) | `"KR"` 고정 | 조회국가기준 |
| `fnc_or_cd` (금융기관) | `"KEXIM"` 고정 | 조회 기관 (수출입은행) |
| `std_ymd` (기준일자) | **수집 요청일자** | `YYYYMMDD` (당일) |
| `anno_dgrcnt` (고시회차) | `"1"` 고정 | 일 1회 수집 가정 |
| `mon_cd` (통화코드) | API: `cur_unit` | 조회 통화(예: `USD`) |
| `sendmoney_sndg` (송금출발) | API: `tts` | 문자열 콤마 제거 후 숫자(Decimal) 저장 |
| `sendmoney_rcvng` (송금도착)  | API: `ttb` | 문자열 콤마 제거 후 숫자 저장 |
| `tradg_std_rt` (매매기준율) | API: `deal_bas_r` | 문자열 콤마 제거 후 숫자 저장 |
| `convmoney_rt` (환가료율) | API: `bkpr` | (장부가격 대치) 문자열 콤마 제거 및 숫자 변환 |
| `if_yn_cd` / `use_yn_cd` | `"Y"` / `"Y"` 고정 | API 연동건 및 사용 확인여부 |

---

## 3. 사용 가이드 (How To Use)

### 3.1. 인증키(API Key) 환경변수 설정
본 배치 작업은 `EXCHANGE_API_KEY` 환경변수를 키 값으로 사용하고 있습니다. 
로컬 `.env` 혹은 서버 환경변수 설정 파일에 아래 구문을 추가해 주세요.
```env
EXCHANGE_API_KEY=발급받으신_수출입은행_API_KEY문자열
```

### 3.2. 수동 실행 (콘솔 테스트)
레일즈 콘솔(`rails c`)에서 다음과 같이 즉시 실행하여 오늘 환율 정보를 가져오고 DB에 적재해 볼 수 있습니다.

```ruby
# [방식 1] ActiveJob 큐에 밀어 넣기 (비동기 처리)
Std::SyncExchangeRatesJob.perform_later

# [방식 2] 동기적으로 바로 실행 및 로그 확인
Std::ExchangeRateSyncService.new(Date.current).call

# 만약 과거 특정 일자의 데이터를 억지로 넣고 싶다면?
Std::ExchangeRateSyncService.new(Date.parse('20240101')).call
```
*실행 시 콘솔(혹은 로그)에 아래처럼 출력이 기록됩니다.*
> `Info [ExchangeRateSyncService] 수집 요청 시작 (일자: 20240222)`
> `Info [ExchangeRateSyncService] 수집 실패 또는 비영업일... 이전 영업일 재탐색(1)...`
> `Info [ExchangeRateSyncService] 수집 및 저장 완료 (기준일자: 20240222, 스캔일자: 20240221, 저장건수: 25)`

### 3.3. 정기 스케줄링(Batch) 연동
시스템에서 사용 중인 스케줄러(Whenever, Sidekiq-cron 등) 설정에 다음 코드를 추가하세요.

**[whenever gem 사용 시 예시 (`config/schedule.rb`)]**
```ruby
# 매일 오전 11:30 혹은 적정 시각에 실행 (환율 고시 직후)
every 1.day, at: '11:45 am' do
  runner "Std::SyncExchangeRatesJob.perform_later"
end
```

---

## 4. 특이사항 검토 (Troubleshooting)
*   **"저장건수: 0" 이 나오는 상황**: API 키가 없거나, API 사용 한도 초과(수출입은행 일일 1,000회 등), 혹은 인증이 실패한 상황에서 발생할 수 있습니다. `response.body`의 내용을 로깅(Logging) 등을 통해 체크해야 합니다.
*   **통화코드(mon_cd)가 비정상 포맷**: 예를 들어 `100(JPY)` 등으로 올 경우 정해진 포맷을 맞추기 위해 파싱 단계 시 분리(Split) 또는 정규식을 필요로 할 수 있으니(현 로직은 `cur_unit` 값 그대로 담음) 데이터 확인 후 조치가 필요할 수 있습니다.
