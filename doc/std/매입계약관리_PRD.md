# PRD: 매입계약관리 (Purchase Contract Management)

## 1. User Flow
사용자가 매입계약 관리 화면에 진입하여 계약 정보를 조회, 등록, 수정, 삭제하는 전체적인 흐름입니다.

1.  **화면 진입 (Initial Load)**
    *   사용자가 화면을 열면 시스템은 로그인 정보(법인코드, ID 등)와 현재 날짜를 기준으로 초기값을 설정합니다.
    *   계약구분, 계약종류 등 필요한 공통코드 목록을 서버로부터 가져와 콤보박스에 바인딩합니다.

2.  **계약 목록 조회 (Search)**
    *   사용자는 검색 조건(법인, 거래처, 계약구분, 계약번호, 조회기간 등)을 입력합니다.
    *   '조회(Search)' 버튼을 클릭하면 조건에 맞는 매입계약 목록이 그리드(List)에 표시됩니다.

3.  **상세 정보 확인 (View Details)**
    *   목록에서 특정 계약 건을 클릭하면 하단 탭 영역(기본정보, 추가정보, 정산정보, 변경이력)에 상세 데이터가 바인딩됩니다.

4.  **신규 계약 등록 (Create)**
    *   '행추가' 버튼을 클릭합니다.
    *   필수 입력값(거래처, 계약기간, 부서 등)을 입력합니다. 거래처 선택 시 관련 기본 정보(부가세, 결재방법 등)가 자동으로 채워집니다.
    *   '저장' 버튼을 클릭하면 신규 계약 번호가 생성되며 DB에 저장됩니다.

5.  **계약 정보 수정 (Update)**
    *   기존 계약 정보를 수정하고 '저장' 버튼을 클릭합니다.
    *   수정된 내용은 DB에 반영되며, 변경 전 데이터는 '매입계약 변경이력 테이블(TB_CM05011)'에 이력으로 저장됩니다.

6.  **계약 삭제 (Delete)**
    *   목록에서 삭제할 건을 선택하고 '삭제' 버튼을 클릭합니다.
    *   매입계약번호가 있는 데이터의 경우, 실제 삭제 대신 '사용여부'가 '아니오(No)'로 변경됩니다 (Soft Delete).

---

## 2. UI Component 리스트
화면은 크게 검색 영역(Search), 목록 영역(List), 상세 정보 탭 영역(Detail Tab)으로 구성됩니다.

### 2.1 Search Area (검색 조건)
| UI Label | Component Type | 설명 | 비고 |
| :--- | :--- | :--- | :--- |
| 법인 | Input + Popup | 법인코드 및 법인명 검색 | 필수 |
| 거래처 | Input + Popup | 거래처코드 및 거래처명 검색 | 거래처그룹 '10'(고객) 제외 |
| 계약구분 | Combo Box | 계약 구분 선택 (기본값: 전체) | 공통코드 144 |
| 계약번호 | Input Text | 매입계약번호 직접 입력 | |
| 조회기간 | Calendar (From~To) | 계약 기간 범위 설정 | 시작일 <= 종료일 체크 |

### 2.2 List Area (매입계약 목록)
| Column Header | Component Type | 설명 |
| :--- | :--- | :--- |
| 거래처번호 | Text (Read-only) | 거래처 코드 |
| 거래처명 | Text (Read-only) | 거래처 명칭 |
| 매입계약번호 | Text (Read-only) | 계약 식별 번호 |
| 매입계약명 | Text (Read-only) | 계약 명칭 |
| 사업자번호 | Text (Read-only) | 사업자 등록 번호 |
| 계약구분 | Text (Read-only) | 계약 구분 명칭 |
| 계약종류 | Text (Read-only) | 계약 종류 명칭 |
| 계약시작일자 | Text (Read-only) | YYYY-MM-DD 형식 |
| 계약종료일자 | Text (Read-only) | YYYY-MM-DD 형식 |
| 사용여부 | Text (Read-only) | 예/아니오 |

### 2.3 Detail Area (상세 정보 탭)
하단은 4개의 탭으로 구성됩니다.

*   **Tab 1: 매입계약기본정보**
    *   **입력 필드:** 매입계약명, 사업자번호, 계약구분(Combo), 계약종류(Combo), 전계약번호, 최초계약일자(Calendar), 계약시작일(Calendar), 계약종료일(Calendar), 계약연장일자(Calendar), 계약만료알림일자(Calendar), 계약해지일자(Calendar), 여신한도초과여부, 부가세구분, 결재방법, 청구방법 등.
    *   **검색 버튼:** 거래처 찾기, 부서 찾기, 계약담당자 찾기.

*   **Tab 2: 매입계약추가정보**
    *   **입력 필드:** 계약변경사유, 운영권역, 재계약조건, 계약해지조건, 지급조건, 거래처구분, 작업단계레벨1/2, 비고.

*   **Tab 3: 매입계약정산정보**
    *   **Grid List:** 일련번호, 은행코드, 계좌번호, 예금주명, 화폐코드, 환율적용 등.

*   **Tab 4: 매입계약변경이력정보**
    *   **Grid List:** 변경테이블명, 변경컬럼명, 변경전내용, 변경후내용, 수정자, 수정일시.

*   **Action Buttons:** 행추가, 행삭제, 저장.

---

## 3. Data Mapping
주요 필드에 대한 데이터 속성 및 제약조건 정의입니다.

| 한글명 | 영문명(Column) | Type | PK/FK | 필수 | Validation / Format |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **매입계약번호** | `purCtrtNoCd` | Varchar(13) | PK | Y | 구분(1)+년월일(8)+순번(4) |
| **매입계약명** | `purCtrtNmCd` | Varchar | | Y | |
| **거래처코드** | `bzacCd` | Varchar | FK | Y | TB_CM04001 참조 |
| **사업자번호** | `bizmanNo` | Varchar | | Y | ###-###-#### 형식 |
| **최초계약일자** | `strtCtrtYmd` | Date | | Y | YYYY-MM-DD |
| **계약시작일** | `ctrtStrtDay` | Date | | Y | YYYY-MM-DD |
| **계약종료일** | `ctrtEndDay` | Date | | Y | YYYY-MM-DD |
| **계약구분** | `ctrtSctnCd` | Varchar | | Y | 공통코드 144 참조 |
| **계약종류** | `ctrtKindCd` | Varchar | | Y | 공통코드 31 참조 |
| **부가세구분** | `vatSctnCd` | Varchar | | Y | 공통코드 131 참조 |
| **사용여부** | `useYnCd` | Char(1) | | Y | 전체(사용/미사용) |
| **등록자** | `regrCd` | Varchar | | Y | 로그인 사용자 ID 자동입력 |
| **수정일시** | `chgdt` | Timestamp | | Y | DB Sysdate |

---

## 4. Logic Definition
화면 동작 및 데이터 처리를 위한 비즈니스 로직 정의입니다.

### 4.1 초기화 및 공통코드 로딩 (Initialization)
*   **이벤트:** 화면 Open 시 실행.
*   **로직:**
    *   로그인 사용자 정보를 바탕으로 법인코드/명 등을 기본 세팅.
    *   다음의 공통코드를 조회하여 컴포넌트에 바인딩:
        *   계약구분(144), 계약종류(31), 부가세구분(131), 결재방법(143), 결재유형(142), 청구방법(65), 해지사유(145), 지급조건(141), 거래처구분(04), 작업단계레벨1(07), 작업단계레벨2(08), 화폐코드(27), 공시차수(26), 환율적용환산기준(147).
    *   작업단계레벨2는 레벨1 선택 값에 종속되어 필터링 조회.

### 4.2 유효성 검사 (Validation)
*   **날짜 체크:**
    *   조회 기간: 시작일(From)이 종료일(To)보다 클 수 없음.
    *   계약 기간 논리: `최초계약일자 <= 계약시작일 < 계약종료일 < 계약연장일자` 순서를 만족해야 함.
*   **거래처 체크:**
    *   거래처구분 상위 코드인 '거래처그룹코드'가 '20'(협력사)이 아닌 경우 경고 메시지를 표시하고 진행.

### 4.3 데이터 등록/수정 자동화 (Automation)
*   **거래처 선택 시:**
    *   거래처 마스터(TB_CM04001)에서 부가세구분, 결재방법, 결재유형 등의 기본 정보를 가져와 화면에 자동 매핑.
    *   거래처가 등록되지 않았거나 사업자등록증(TB_CM05003)이 없는 경우 신규 등록 불가 메시지 처리.
*   **사원(담당자) 선택 시:**
    *   사원 정보의 부서코드를 조회하여 계약 부서코드와 부서명을 자동으로 표시 (수정 가능).

### 4.4 저장 프로세스 (Save Logic)
*   **매입계약번호 생성 규칙:**
    *   `구분(1자리) + 년월일(8자리) + 순번(4자리)` 총 13자리.
    *   구분자: 매입(1), 매입(2), 임대(3), 기타(4).
*   **수정 시 이력 관리:**
    *   저장 시 '수정'으로 판단되는 경우, 수정 전 데이터를 `TB_CM05011` (매입계약 변경이력 테이블)에 저장합니다. 이때 매입계약번호의 순번을 추가하여 키를 생성합니다.
*   **삭제 로직:**
    *   물리적 삭제가 아닌 논리적 삭제(Soft Delete)를 수행합니다.
    *   매입계약번호가 이미 존재하는 데이터는 `사용여부` 필드만 '아니오'로 업데이트합니다.

### 4.5 팝업 연동 (Popups)
*   **법인/거래처/부서/금융기관/사원 선택:**
    *   각 팝업(`CorpSlcPopup`, `BzacSlcPopup`, `DeptSlcPopup` 등) 호출 후 결과값이 1건이면 팝업 없이 바로 필드에 세팅, 다건이면 선택 화면을 표시.
