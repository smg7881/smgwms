<%# app/views/shared/resource_form/fields/_popup.html.erb %>
<%
  param_key = model&.model_name&.param_key || 'resource'
  code_field = field[:code_field].to_s
  error_message = model&.errors&.[](code_field.to_sym)&.first || model&.errors&.[](field[:field].to_sym)&.first

  display_width = field[:display_width].presence
  code_width = field[:code_width].presence || "120px"
  button_width = field[:button_width].presence || "32px"

  if field[:hide_display]
    grid_template = "#{code_width} #{button_width}"
  elsif display_width
    grid_template = "#{code_width} #{button_width} calc(#{display_width} - #{code_width} - #{button_width} - 0.5rem)"
  else
    grid_template = "#{code_width} #{button_width} 1fr"
  end

  display_style = if display_width.present?
    "flex: 0 0 #{display_width}; max-width: #{display_width}; min-width: 0;"
  else
    "flex: 1 1 auto; min-width: 0;"
  end
  code_style = "flex: 0 0 #{code_width}; max-width: #{code_width};"
  button_style = "width: #{button_width}; min-width: #{button_width};"

  code_value = if model.respond_to?(code_field)
    model&.public_send(code_field)
  else
    nil
  end
%>
<div class="flex flex-col gap-1 col-span-24 min-w-0 <%= span_classes_for(field, cols: cols) %>"
     data-resource-form-target="fieldGroup"
     data-field-name="<%= code_field %>"
     data-controller="search-popup"
     data-search-popup-type-value="<%= field[:popup_type] %>"
     data-search-popup-title-value="<%= resolve_label(field) %> 조회">
  <label class="text-sm font-medium text-text-secondary" for="<%= "#{param_key}_#{code_field}" %>">
    <%= resolve_label(field) %>
    <% if field[:required] %><span class="text-accent-rose ml-0.5 font-semibold">*</span><% end %>
  </label>
  <div class="grid gap-1" style="grid-template-columns: <%= grid_template %>;">
    <%= f.text_field code_field.to_sym,
           id: "#{param_key}_#{code_field}",
           name: "#{param_key}[#{code_field}]",
           class: "form-grid-input #{'rf-field-error' if error_message.present?}",
           value: code_value,
           required: field[:required],
           readonly: field[:readonly],
           data: {
             resource_form_target: "input",
             action: "blur->resource-form#validateField"
           }.merge(field[:data] || {}) %>

    <%
      btn_action = []
      if field[:data] && field[:data][:action_target]
        btn_action << "click->#{local_assigns[:target_controller]}##{field[:data][:action_target]}"
      end
      btn_action << "search-popup#open"
    %>
    <button type="button"
            class="rf-popup-btn inline-flex items-center justify-center h-9 border border-border bg-bg-tertiary text-text-primary rounded-md cursor-pointer hover:bg-bg-hover"
            style="<%= button_style %>"
            aria-label="<%= resolve_label(field) %> 찾기"
            data-action="<%= btn_action.join(' ') %>">
      <%= lucide_icon("search", css_class: "w-4 h-4") %>
    </button>

    <% unless field[:hide_display] %>
      <%= f.text_field field[:field].to_sym,
             id: "#{param_key}_#{field[:field]}",
             value: field[:value].to_s,
             class: "form-grid-input #{'rf-field-error' if error_message.present?}",
             style: display_style,
             data: {
               search_popup_target: "display",
               action: "input->search-popup#onDisplayInput blur->resource-form#validateField"
             },
             placeholder: resolve_placeholder(field) || "#{resolve_label(field)} 선택" %>
    <% end %>
  </div>
  <span class="rf-error-msg <%= 'invisible' if error_message.blank? %>"><%= error_message.presence || " " %></span>
</div>
