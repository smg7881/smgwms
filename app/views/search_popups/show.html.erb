<%
  financial_org_popup = %w[financial_institution fin_org financial_org fnc_or].include?(@type)
  sellbuy_attr_popup = %w[sellbuy_attr sellbuyattribute sell_buy_attr].include?(@type)

  popup_title = if @type == "corp"
    "법인 조회"
  elsif financial_org_popup
    "금융기관 조회"
  elsif sellbuy_attr_popup
    "매출입항목 조회"
  else
    "조회"
  end

  if @type == "corp"
    popup_fields = [
      {
        field: "corp_cd",
        type: "input",
        label: "법인코드",
        placeholder: "법인코드 입력",
        target: "corpCd"
      },
      {
        field: "corp_nm",
        type: "input",
        label: "법인명",
        placeholder: "법인명 입력",
        target: "corpNm"
      },
      {
        field: "use_yn",
        type: "select",
        label: "사용여부",
        options: [
          { label: "Y", value: "Y" },
          { label: "N", value: "N" }
        ],
        include_blank: false,
        target: "useYn"
      }
    ]

    popup_columns = [
      { field: "corp_cd", headerName: "법인코드", minWidth: 130, editable: false },
      { field: "corp_nm", headerName: "법인명", minWidth: 220, editable: false },
      { field: "ctry", headerName: "국가", minWidth: 120, editable: false },
      { field: "biz_no", headerName: "사업자등록번호", minWidth: 160, editable: false },
      {
        field: "__select",
        headerName: "선택",
        minWidth: 90,
        maxWidth: 90,
        editable: false,
        sortable: false,
        filter: false,
        resizable: false,
        cellStyle: { textAlign: "center" },
        cellRenderer: "popupSelectCellRenderer"
      }
    ]

    popup_rows = @rows.map do |row|
      {
        corp_cd: row[:corp_cd],
        corp_nm: row[:corp_nm],
        ctry: row[:ctry],
        biz_no: row[:biz_no],
        code: row[:code],
        name: row[:name],
        display: row[:display],
        upper_corp_cd: row[:upper_corp_cd],
        upper_corp_nm: row[:upper_corp_nm]
      }
    end
  elsif financial_org_popup
    popup_fields = [
      {
        field: "ctry_cd",
        type: "input",
        label: "국가코드",
        placeholder: "국가코드 입력"
      },
      {
        field: "fnc_or_cd",
        type: "input",
        label: "금융기관코드",
        placeholder: "금융기관코드 입력"
      },
      {
        field: "fnc_or_nm",
        type: "input",
        label: "금융기관명",
        placeholder: "금융기관명 입력"
      },
      {
        field: "use_yn",
        type: "select",
        label: "사용여부",
        options: [
          { label: "Y", value: "Y" },
          { label: "N", value: "N" }
        ],
        include_blank: false
      }
    ]

    popup_columns = [
      { field: "ctry", headerName: "국가", minWidth: 120, editable: false },
      { field: "fnc_or_cd", headerName: "금융기관코드", minWidth: 140, editable: false },
      { field: "fnc_or_nm", headerName: "금융기관명", minWidth: 200, editable: false },
      { field: "fnc_or_eng_nm", headerName: "금융기관영문명", minWidth: 220, editable: false },
      {
        field: "__select",
        headerName: "선택",
        minWidth: 90,
        maxWidth: 90,
        editable: false,
        sortable: false,
        filter: false,
        resizable: false,
        cellStyle: { textAlign: "center" },
        cellRenderer: "popupSelectCellRenderer"
      }
    ]

    popup_rows = @rows.map do |row|
      {
        code: row[:code],
        name: row[:name],
        display: row[:display],
        ctry: row[:ctry],
        ctry_cd: row[:ctry_cd],
        ctry_nm: row[:ctry_nm],
        fnc_or_cd: row[:fnc_or_cd] || row[:code],
        fnc_or_nm: row[:fnc_or_nm] || row[:name],
        fnc_or_eng_nm: row[:fnc_or_eng_nm],
        use_yn: row[:use_yn]
      }
    end
  elsif sellbuy_attr_popup
    popup_fields = [
      {
        field: "sellbuy_attr_cd",
        type: "input",
        label: "매출입항목코드",
        placeholder: "매출입항목코드 입력"
      },
      {
        field: "sellbuy_attr_nm",
        type: "input",
        label: "매출입항목명",
        placeholder: "매출입항목명 입력"
      },
      {
        field: "corp_nm",
        type: "popup",
        label: "법인",
        popup_type: "corp",
        code_field: "corp_cd",
        placeholder: "법인 선택"
      },
      {
        field: "use_yn",
        type: "select",
        label: "사용여부",
        options: [
          { label: "Y", value: "Y" },
          { label: "N", value: "N" }
        ],
        include_blank: false
      },
      {
        field: "tran_yn",
        type: "select",
        label: "운송여부",
        options: [
          { label: "전체", value: "" },
          { label: "Y", value: "Y" },
          { label: "N", value: "N" }
        ],
        include_blank: false
      },
      {
        field: "strg_yn",
        type: "select",
        label: "보관여부",
        options: [
          { label: "전체", value: "" },
          { label: "Y", value: "Y" },
          { label: "N", value: "N" }
        ],
        include_blank: false
      }
    ]

    popup_columns = [
      { field: "sellbuy_attr_cd", headerName: "매출입항목코드", minWidth: 140, editable: false },
      { field: "sellbuy_attr_nm", headerName: "매출입항목명", minWidth: 190, editable: false },
      { field: "sellbuy_attr_eng_nm", headerName: "영문매출입항목명", minWidth: 210, editable: false },
      { field: "rdtn_nm", headerName: "단축명", minWidth: 140, editable: false },
      { field: "upper_sellbuy_attr_cd", headerName: "상위매출입항목코드", minWidth: 150, editable: false },
      { field: "upper_sellbuy_attr_nm", headerName: "상위매출입항목명", minWidth: 170, editable: false },
      {
        field: "__select",
        headerName: "선택",
        minWidth: 90,
        maxWidth: 90,
        editable: false,
        sortable: false,
        filter: false,
        resizable: false,
        cellStyle: { textAlign: "center" },
        cellRenderer: "popupSelectCellRenderer"
      }
    ]

    popup_rows = @rows.map do |row|
      {
        code: row[:code],
        name: row[:name],
        display: row[:display],
        corp_cd: row[:corp_cd],
        sellbuy_attr_cd: row[:sellbuy_attr_cd] || row[:code],
        sellbuy_attr_nm: row[:sellbuy_attr_nm] || row[:name],
        sellbuy_attr_eng_nm: row[:sellbuy_attr_eng_nm],
        rdtn_nm: row[:rdtn_nm],
        upper_sellbuy_attr_cd: row[:upper_sellbuy_attr_cd],
        upper_sellbuy_attr_nm: row[:upper_sellbuy_attr_nm],
        tran_yn: row[:tran_yn],
        strg_yn: row[:strg_yn],
        use_yn: row[:use_yn]
      }
    end
  else
    popup_fields = [
      {
        field: "display",
        type: "input",
        label: "명칭",
        placeholder: "명칭 입력",
        target: "keyword"
      },
      {
        field: "code",
        type: "input",
        label: "코드",
        placeholder: "코드",
        disabled: true,
        target: "code"
      }
    ]

    popup_columns = [
      { field: "name", headerName: "명칭", minWidth: 220, editable: false },
      { field: "code", headerName: "코드", minWidth: 120, maxWidth: 160, editable: false },
      {
        field: "__select",
        headerName: "선택",
        minWidth: 90,
        maxWidth: 90,
        editable: false,
        sortable: false,
        filter: false,
        resizable: false,
        cellStyle: { textAlign: "center" },
        cellRenderer: "popupSelectCellRenderer"
      }
    ]

    popup_rows = @rows.map do |row|
      {
        name: row[:name],
        code: row[:code],
        display: row[:display]
      }
    end
  end
%>

<turbo-frame id="<%= @frame %>">
<div class="p-4"
     data-controller="search-popup-grid"
     data-action="ag-grid:ready->search-popup-grid#registerGrid search-popup-grid:select->search-popup-grid#selectFromRenderer">

  <%= render Ui::SearchFormComponent.new(
    url: search_popup_path(@type, frame: @frame),
    fields: popup_fields,
    cols: 3,
    turbo_frame: @frame,
    class: "mb-4"
  ) %>

  <%= render Ui::GridHeaderComponent.new(
    icon: "list", title: popup_title, grid_id: "popup-grid"
  ) %>

  <%= render Ui::AgGridComponent.new(
    columns: popup_columns,
    row_data: popup_rows,
    pagination: false,
    row_selection: "single",
    height: "min(56vh, 480px)",
    data: {
      search_popup_grid_target: "grid"
    }
  ) %>

</div>
</turbo-frame>
