<div data-controller="om-internal-order"
       data-om-internal-order-search-url-value="<%= search_url %>"
       data-om-internal-order-create-url-value="<%= create_url %>"
       data-om-internal-order-update-url-value="<%= update_url %>"
       data-om-internal-order-cancel-url-value="<%= cancel_url %>">

    <!-- 검색 조건 및 상단 툴바 영역 -->
    <div class="flex justify-between items-end mb-4">
      <!-- 좌측 검색 영역 -->
      <%= render Ui::SearchFormComponent.new(
        url: collection_path(format: :json),
        fields: search_fields,
        cols: 4,
        enable_collapse: true
      ) %>

      <!-- 우측 툴바 버튼 영역 -->
      <%= render Ui::GridToolbarComponent.new(
        buttons: [
          { label: "행추가", class: "btn btn-sm btn-primary", action: "click->client-grid#addMasterRow" },
          { label: "행삭제", class: "btn btn-sm btn-danger", action: "click->client-grid#deleteMasterRows" },
          { label: "저장", class: "btn btn-sm btn-success", action: "click->client-grid#saveMasterRows" }
        ]
      ) %>
    </div>

    <!-- 마스터 : 오더 헤더 폼 -->
    <div class="mb-4" data-om-internal-order-target="headerForm">
      <%= render Ui::ResourceFormComponent.new(
        model: nil,
        title: "기본 정보",
        fields: [
          # 1 Row
          { field: "ord_no", type: "input", label: "오더번호", disabled: true, data: { om_internal_order_target: "fieldOrdNo" }, placeholder: "저장 시 자동 채번" },
          { field: "ord_stat_cd", type: "input", label: "오더상태", disabled: true, data: { om_internal_order_target: "fieldOrdStatCd" } },
          { field: "create_time", type: "input", label: "생성일시", disabled: true, data: { om_internal_order_target: "fieldCreateTime" } },
          { field: "ord_type_cd", type: "select", label: "오더유형", options: common_code_options("75"), include_blank: "선택", disabled: true, data: { om_internal_order_target: "fieldOrdTypeCd" } },
          
          # 2 Row
          { field: "ctrt_no", type: "input", label: "계약번호", disabled: true, data: { om_internal_order_target: "fieldCtrtNo" } },
          { 
            field: "bilg_cust_nm", 
            type: "popup", 
            label: "청구고객", 
            popup_type: "client",
            code_field: "bilg_cust_cd",
            disabled: true,
            data: { 
              om_internal_order_target: "fieldBilgCustNm",
              code_target: "fieldBilgCustCd",
              action_target: "bilgCustSearchBtn"
            }
          },
          { 
            field: "ctrt_cust_nm", 
            type: "popup", 
            label: "계약고객", 
            popup_type: "client",
            code_field: "ctrt_cust_cd",
            disabled: true,
            data: { 
              om_internal_order_target: "fieldCtrtCustNm",
              code_target: "fieldCtrtCustCd",
              action_target: "ctrtCustSearchBtn"
            }
          },
          { field: "ord_reason_cd", type: "select", label: "사유코드", options: common_code_options("87"), include_blank: "선택", disabled: true, data: { om_internal_order_target: "fieldOrdReasonCd" } },

          # 3 Row
          { 
            field: "ord_exec_dept_cd", 
            type: "input", 
            label: "실행부서", 
            disabled: true, 
            data: { om_internal_order_target: "fieldOrdExecDeptCd" }
          },
          { 
            field: "ord_exec_ofcr_cd", 
            type: "input", 
            label: "실행담당자", 
            disabled: true, 
            data: { om_internal_order_target: "fieldOrdExecOfcrCd" }
          },
          { field: "remk", type: "input", label: "특이사항", disabled: true, col_span: 2, data: { om_internal_order_target: "fieldRemk" } }
        ],
        cols: 4,
        show_buttons: false,
        form_data: { om_internal_order_target: "form" }
      ) %>
    </div>

    <!-- 탭 영역 : 출도착지상세 / 아이템상세 -->
    <div class="bg-white rounded shadow-sm border">
      <!-- 탭 헤더 -->
      <div class="flex border-b">
        <button type="button" class="px-4 py-2 text-sm font-medium border-b-2 border-blue-500 text-blue-600"
                data-action="click->om-internal-order#switchTab"
                data-om-internal-order-target="tabBtnLocation"
                data-tab="location">
          출도착지상세
        </button>
        <button type="button" class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700"
                data-action="click->om-internal-order#switchTab"
                data-om-internal-order-target="tabBtnItems"
                data-tab="items">
          아이템상세
        </button>
      </div>

      <!-- 출도착지상세 탭 -->
      <div class="p-4" data-om-internal-order-target="tabLocation">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- 출발지 그룹 -->
          <div>
            <%= render Ui::ResourceFormComponent.new(
              model: nil,
              title: "출발지 정보",
              fields: [
                { field: "dpt_type_cd", type: "select", label: "유형", options: loc_type_options, include_blank: "선택", disabled: true, data: { om_internal_order_target: "fieldDptTypeCd", action: "change->om-internal-order#onDptTypeChange" } },
                { field: "dpt_cd", type: "input", label: "코드", disabled: true, data: { om_internal_order_target: "fieldDptCd" } },
                { field: "dpt_zip_cd", type: "input", label: "우편번호", disabled: true, data: { om_internal_order_target: "fieldDptZipCd" } },
                { field: "dpt_addr", type: "input", label: "주소", disabled: true, data: { om_internal_order_target: "fieldDptAddr" } },
                { field: "strt_req_ymd", type: "input", input_type: "date", label: "시작요청일", disabled: true, data: { om_internal_order_target: "fieldStrtReqYmd" } }
              ],
              cols: 1,
              show_buttons: false
            ) %>
          </div>

          <!-- 도착지 그룹 -->
          <div>
            <%= render Ui::ResourceFormComponent.new(
              model: nil,
              title: "도착지 정보",
              fields: [
                { field: "arv_type_cd", type: "select", label: "유형", options: loc_type_options, include_blank: "선택", disabled: true, data: { om_internal_order_target: "fieldArvTypeCd", action: "change->om-internal-order#onArvTypeChange" } },
                { field: "arv_cd", type: "input", label: "코드", disabled: true, data: { om_internal_order_target: "fieldArvCd" } },
                { field: "arv_zip_cd", type: "input", label: "우편번호", disabled: true, data: { om_internal_order_target: "fieldArvZipCd" } },
                { field: "arv_addr", type: "input", label: "주소", disabled: true, data: { om_internal_order_target: "fieldArvAddr" } },
                { field: "aptd_req_dtm", type: "input", input_type: "datetime-local", label: "납기요청일시", disabled: true, data: { om_internal_order_target: "fieldAptdReqDtm" } }
              ],
              cols: 1,
              show_buttons: false
            ) %>
          </div>
        </div>
      </div>

      <!-- 아이템상세 탭 -->
      <div class="p-4 hidden" data-om-internal-order-target="tabItems">
        <div class="flex items-center justify-between gap-3 mb-3">
          <h3 class="inline-flex items-center gap-2 text-[15px] font-semibold text-text-primary">
            <%= helpers.lucide_icon("list", css_class: "w-4 h-4 text-gray-500") %>
            아이템 목록 (최대 20건)
            <%= render Ui::GridActionsComponent.new(grid_id: "om-internal-order-items") %>
          </h3>
          <%= render Ui::GridToolbarComponent.new(
            buttons: [
              { label: "행추가", class: "btn btn-sm btn-primary", action: "click->om-internal-order#addItemRow" },
              { label: "행삭제", class: "btn btn-sm btn-danger", action: "click->om-internal-order#deleteItemRows" }
            ]
          ) %>
        </div>

        <div class="h-[300px]">
          <%= render Ui::AgGridComponent.new(
            columns: item_columns,
            row_data: [],
            height: "300px",
            pagination: false,
            row_selection: "multiple",
            grid_id: "om-internal-order-items",
            data: {
              om_internal_order_target: "itemGrid",
              action: "ag-grid:ready->om-internal-order#registerItemGrid"
            }
          ) %>
        </div>
      </div>
    </div>
  </div>
